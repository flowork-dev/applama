<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover" />
    <title>SONIC RIPPER | MOBILE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="../../assets/js/auto-tracker.js"></script>

    <style>
        :root {
            --bg-deep: #0b0c15;
            --cyber-cyan: #54d7f6;
            --neon-purple: #706bf3;
            --panel-bg: #13151f;
        }

        body {
            background-color: var(--bg-deep);
            color: #e0f0ff;
            font-family: 'Segoe UI', Roboto, Helvetica, sans-serif;
            overscroll-behavior-y: none; /* Mencegah pull-to-refresh native */
            -webkit-tap-highlight-color: transparent;
        }

        /* Hide Scrollbar but allow scrolling */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        /* Custom Toast Animation */
        .toast-enter { animation: slideIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .toast-exit { animation: slideOut 0.3s ease-in forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes slideOut { from { opacity: 1; transform: translateY(0) scale(1); } to { opacity: 0; transform: translateY(-20px) scale(0.9); } }

        /* Glassmorphism for Sticky Header - BOOSTED */
        .glass-header {
            background: rgba(11, 12, 21, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(84, 215, 246, 0.1);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.8);
        }

        /* Gradient Borders */
        .cyber-border {
            position: relative;
            background: var(--panel-bg);
            border-radius: 0.75rem;
            z-index: 1;
        }
        .cyber-border::before {
            content: "";
            position: absolute;
            inset: -1px;
            z-index: -1;
            border-radius: 0.8rem;
            background: linear-gradient(45deg, transparent, rgba(84,215,246,0.3), transparent);
            opacity: 0.5;
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <nav class="h-16 flex items-center justify-between px-5 bg-[#0b0c15] border-b border-[#3a3962]/50 shrink-0 z-50 shadow-lg">
        <div class="font-black text-xl tracking-widest flex items-center gap-2">
            <i data-lucide="waves" class="text-[#54d7f6] w-6 h-6 animate-pulse"></i>
            <span class="font-mono text-white italic">SONIC<span class="text-[#54d7f6]">RIPPER</span></span>
        </div>
        <div class="px-3 py-1 bg-[#3a3962]/30 rounded-full text-[10px] font-bold text-[#54d7f6] border border-[#54d7f6]/20 shadow-[0_0_10px_rgba(84,215,246,0.2)]">
            V3.1 MOBILE
        </div>
    </nav>

    <div id="toast-container" class="fixed top-20 left-0 right-0 z-[100] flex flex-col items-center gap-2 pointer-events-none px-4"></div>

    <main class="flex-1 overflow-y-auto hide-scroll relative w-full pb-24">

        <div class="sticky top-0 z-40 glass-header p-5 transition-all">
            <div class="relative group w-full">
                <input type="file" id="fileInput" accept="video/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20"
                    onchange="window.appCore.handleFileSelect(this)">

                <div id="drop-zone" class="relative h-28 bg-[#13151f] rounded-2xl border-2 border-dashed border-[#3a3962] group-active:border-[#54d7f6] group-active:bg-[#1a1d2b] flex flex-col items-center justify-center gap-3 transition-all shadow-inner overflow-hidden">

                    <div class="absolute inset-0 bg-gradient-to-tr from-transparent via-[#54d7f6]/5 to-transparent opacity-0 group-active:opacity-100 transition-opacity pointer-events-none"></div>

                    <div id="icon-wrapper" class="p-3 rounded-full bg-[#0b0c15] border border-[#3a3962] group-active:scale-110 transition-transform">
                        <i data-lucide="upload-cloud" class="text-gray-400 w-6 h-6 transition-colors"></i>
                    </div>
                    <div class="text-center w-full px-4 z-10">
                        <p id="fileName" class="text-sm font-bold text-white truncate w-full tracking-wide">TAP TO SELECT VIDEO</p>
                        <p id="fileInfo" class="text-[10px] text-gray-500 font-mono mt-1">MP4 / MKV / WEBM (MAX 2GB)</p>
                    </div>
                </div>
            </div>

            <div class="mt-4 flex items-center justify-between text-[10px] text-[#54d7f6] font-mono font-bold mb-1">
                <span id="progress-text" class="tracking-wider">SYSTEM READY</span>
                <span id="progress-percent">0%</span>
            </div>
            <div class="w-full bg-[#0b0c15] h-2 rounded-full overflow-hidden border border-[#3a3962]/50 shadow-inner">
                <div id="progress-bar" class="h-full bg-gradient-to-r from-[#54d7f6] via-[#706bf3] to-[#54d7f6] w-0 transition-all duration-300 relative">
                    <div class="absolute inset-0 bg-white/20 animate-pulse"></div>
                </div>
            </div>
        </div>

        <div class="p-5 space-y-8">

            <div class="grid grid-cols-2 bg-[#0b0c15] p-1.5 rounded-xl border border-[#3a3962] shadow-lg">
                <button onclick="window.appCore.setMode('single')" id="tab-single" class="py-3 text-xs font-black tracking-widest rounded-lg bg-[#3a3962] text-white shadow-[0_0_15px_rgba(58,57,98,0.5)] transition-all">
                    SINGLE OPS
                </button>
                <button onclick="window.appCore.setMode('bulk')" id="tab-bulk" class="py-3 text-xs font-bold tracking-widest rounded-lg text-gray-500 hover:text-white transition-all">
                    BULK SPLITTER
                </button>
            </div>

            <div id="panel-single" class="space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-500">
                <div class="grid grid-cols-1 gap-4">
                    <button onclick="window.appCore.processSingle('extract')" class="cyber-border group relative overflow-hidden p-6 text-left active:scale-[0.98] transition-transform">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-active:opacity-30 transition-opacity"><i data-lucide="music" class="w-20 h-20 text-[#54d7f6] -rotate-12"></i></div>
                        <div class="relative z-10">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="p-2 bg-[#54d7f6]/10 rounded-lg text-[#54d7f6]"><i data-lucide="music" class="w-5 h-5"></i></div>
                                <span class="text-base font-black text-white italic">EXTRACT AUDIO</span>
                            </div>
                            <p class="text-xs text-gray-400 leading-relaxed pl-1">Convert video sound to high quality MP3 format instantly.</p>
                        </div>
                    </button>

                    <button onclick="window.appCore.processSingle('mute')" class="cyber-border group relative overflow-hidden p-6 text-left active:scale-[0.98] transition-transform">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-active:opacity-30 transition-opacity"><i data-lucide="volume-x" class="w-20 h-20 text-[#706bf3] -rotate-12"></i></div>
                        <div class="relative z-10">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="p-2 bg-[#706bf3]/10 rounded-lg text-[#706bf3]"><i data-lucide="volume-x" class="w-5 h-5"></i></div>
                                <span class="text-base font-black text-white italic">MUTE VIDEO</span>
                            </div>
                            <p class="text-xs text-gray-400 leading-relaxed pl-1">Remove audio track completely, keep video quality.</p>
                        </div>
                    </button>
                </div>
            </div>

            <div id="panel-bulk" class="hidden space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">

                <div class="cyber-border p-5 space-y-5">
                    <div>
                        <label class="text-[10px] text-[#54d7f6] font-black tracking-widest mb-2 block flex items-center gap-2">
                            <i data-lucide="settings-2" class="w-3 h-3"></i> OUTPUT FORMAT
                        </label>
                        <div class="relative">
                            <select id="splitOutputMode" class="w-full bg-[#0b0c15] text-white text-sm font-medium border border-[#3a3962] rounded-xl p-4 appearance-none outline-none focus:border-[#54d7f6] focus:ring-1 focus:ring-[#54d7f6] transition-all">
                                <option value="audio">ðŸ”Š Audio Only (MP3)</option>
                                <option value="video_audio" selected>ðŸŽ¬ Video + Audio (MP4)</option>
                                <option value="video_muted">ðŸ”‡ Video Muted (MP4)</option>
                            </select>
                            <i data-lucide="chevron-down" class="absolute right-4 top-4 w-5 h-5 text-gray-500 pointer-events-none"></i>
                        </div>
                    </div>

                    <div>
                        <label class="text-[10px] text-[#54d7f6] font-black tracking-widest mb-2 block flex items-center gap-2">
                            <i data-lucide="timer" class="w-3 h-3"></i> SPLIT INTERVAL
                        </label>
                        <div class="flex gap-3">
                            <input type="number" id="splitInterval" value="30" class="flex-1 bg-[#0b0c15] border border-[#3a3962] rounded-xl p-4 text-white text-sm font-bold focus:border-[#54d7f6] outline-none text-center">
                            <button onclick="window.appCore.generateTimestamps()" class="px-6 bg-[#3a3962] active:bg-[#54d7f6] active:text-black text-white rounded-xl text-xs font-black tracking-wider transition-colors shadow-lg">
                                GENERATE
                            </button>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="text-[10px] text-gray-500 font-black tracking-widest mb-2 block pl-1">TIMESTAMP LIST</label>
                    <textarea id="timestampInput" class="w-full h-40 bg-[#0b0c15] border border-[#3a3962] rounded-2xl p-4 text-[#54d7f6] font-mono text-xs focus:border-[#54d7f6] outline-none resize-none shadow-inner leading-relaxed" placeholder="00:00:00-00:00:30&#10;00:00:30-00:01:00..."></textarea>
                </div>

                <button id="btn-split-start" onclick="window.appCore.processBulkSplit()" class="w-full py-5 bg-gradient-to-r from-[#54d7f6] to-[#706bf3] text-black font-black text-lg italic tracking-widest rounded-xl shadow-[0_0_30px_rgba(84,215,246,0.4)] active:scale-[0.98] transition-all flex items-center justify-center gap-3 group relative overflow-hidden">
                    <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                    <i data-lucide="scissors" class="w-6 h-6"></i> START BRUTAL SPLIT
                </button>

                <p class="text-[10px] text-center text-gray-600 font-mono tracking-wide">*Engine resets every chunk + 5s cooldown</p>
            </div>

            <div id="global-footer" class="pt-8 pb-4"></div>

        </div>
    </main>

    <script>
        const AppCore = {
            isLoggedIn: false,
            videoDuration: 0,
            videoFile: null,
            worker: null,

            async init() {
                console.log("SONIC RIPPER V3.1 MOBILE [VISUAL BOOST]");
                if(window.lucide) lucide.createIcons();
                loadFooter();
                this.setMode('single');
            },

            setMode(mode) {
                const btnSingle = document.getElementById('tab-single');
                const btnBulk = document.getElementById('tab-bulk');

                if(mode === 'single') {
                    btnSingle.className = 'py-3 text-xs font-black tracking-widest rounded-lg bg-[#3a3962] text-white shadow-[0_0_15px_rgba(58,57,98,0.5)] transition-all';
                    btnBulk.className = 'py-3 text-xs font-bold tracking-widest rounded-lg text-gray-500 hover:text-white transition-all';
                    document.getElementById('panel-single').classList.remove('hidden');
                    document.getElementById('panel-bulk').classList.add('hidden');
                } else {
                    btnSingle.className = 'py-3 text-xs font-bold tracking-widest rounded-lg text-gray-500 hover:text-white transition-all';
                    btnBulk.className = 'py-3 text-xs font-black tracking-widest rounded-lg bg-[#3a3962] text-white shadow-[0_0_15px_rgba(58,57,98,0.5)] transition-all';
                    document.getElementById('panel-single').classList.add('hidden');
                    document.getElementById('panel-bulk').classList.remove('hidden');
                }
            },

            showToast(msg, type = 'info') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');

                let bgClass = 'bg-[#1f2133] border-[#54d7f6]';
                let icon = 'info';

                if(type === 'error') { bgClass = 'bg-red-900/90 border-red-500'; icon = 'alert-triangle'; }
                if(type === 'success') { bgClass = 'bg-green-900/90 border-green-500'; icon = 'check-circle-2'; }
                if(type === 'loading') { bgClass = 'bg-[#3a3962]/90 border-white'; icon = 'loader-2'; }

                toast.className = `pointer-events-auto w-full max-w-sm p-4 rounded-xl border ${bgClass} text-white text-xs font-bold shadow-2xl toast-enter flex items-center gap-4 backdrop-blur-md z-50`;

                let iconHtml = '';
                if(type === 'loading') iconHtml = `<i data-lucide="${icon}" class="w-5 h-5 animate-spin text-white/80"></i>`;
                else iconHtml = `<i data-lucide="${icon}" class="w-5 h-5 text-white"></i>`;

                toast.innerHTML = `${iconHtml}<span class="tracking-wide">${msg}</span>`;

                container.appendChild(toast);
                if(window.lucide) lucide.createIcons();

                if (type !== 'loading') {
                    setTimeout(() => {
                        toast.classList.remove('toast-enter');
                        toast.classList.add('toast-exit');
                        setTimeout(() => toast.remove(), 300);
                    }, 3000);
                }
                return toast;
            },

            handleFileSelect(input) {
                if(input.files && input.files[0]) {
                    this.videoFile = input.files[0];
                    document.getElementById('fileName').innerText = this.videoFile.name;
                    document.getElementById('fileInfo').innerText = `SIZE: ${(this.videoFile.size / (1024*1024)).toFixed(2)} MB`;

                    const dropZone = document.getElementById('drop-zone');
                    dropZone.classList.add('border-[#54d7f6]', 'bg-[#1a1d2b]');

                    // Icon Update
                    const icon = document.querySelector('#icon-wrapper i');
                    icon.classList.remove('text-gray-400');
                    icon.classList.add('text-[#54d7f6]');

                    const video = document.createElement('video');
                    video.preload = 'metadata';
                    video.onloadedmetadata = () => {
                        this.videoDuration = video.duration;
                        document.getElementById('fileInfo').innerText += ` | DUR: ${this.formatTime(this.videoDuration)}`;
                        URL.revokeObjectURL(video.src);
                    }
                    video.src = URL.createObjectURL(this.videoFile);
                }
            },

            formatTime(seconds) {
                const date = new Date(0);
                date.setSeconds(seconds);
                return date.toISOString().substr(11, 8);
            },

            generateTimestamps() {
                if(!this.videoFile) return this.showToast("Please select a video file first!", "error");

                const interval = parseInt(document.getElementById('splitInterval').value) || 30;
                let text = "";
                let currentTime = 0;

                while(currentTime < this.videoDuration) {
                    const start = this.formatTime(currentTime);
                    const endSec = Math.min(currentTime + interval, this.videoDuration);
                    const end = this.formatTime(endSec);
                    text += `${start}-${end}\n`;
                    currentTime += interval;
                }

                document.getElementById('timestampInput').value = text;
                this.showToast("Timestamps generated successfully!", "success");
            },

            // --- WORKER MANAGEMENT ---
            initWorker() {
                if (this.worker) this.worker.terminate();
                this.worker = new Worker('./js/worker.js');
                this.worker.onerror = (e) => {
                    console.error(e);
                    this.showToast("Worker Error! Check console.", "error");
                    this.updateProgress("CRASHED", 0);
                };
                return this.worker;
            },

            processSingle(mode) {
                if(!this.videoFile) return this.showToast("Select a video first!", "error");

                const worker = this.initWorker();
                const loadingToast = this.showToast("Processing...", "loading");
                this.updateProgress("PROCESSING...", 50);

                worker.postMessage({ type: 'PROCESS', data: { file: this.videoFile, mode: mode } });

                worker.onmessage = (e) => {
                    const { type, buffer, name, msg } = e.data;
                    if (type === 'DONE') {
                        this.downloadFile(buffer, name);
                        loadingToast.remove();
                        this.showToast("Done! File downloaded.", "success");
                        this.updateProgress("COMPLETED", 100);
                        worker.terminate();
                    } else if (type === 'ERROR') {
                        loadingToast.remove();
                        this.showToast(msg, "error");
                        this.updateProgress("FAILED", 0);
                    }
                };
            },

            async processBulkSplit() {
                if(!this.videoFile) return this.showToast("Select a video first!", "error");

                const rawText = document.getElementById('timestampInput').value.trim();
                const outputMode = document.getElementById('splitOutputMode').value;

                if(!rawText) return this.showToast("List is empty! Click Generate.", "error");

                const lines = rawText.split('\n').filter(l => l.trim() !== "");
                const btn = document.getElementById('btn-split-start');

                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                this.updateProgress("INITIALIZING...", 0);

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    const [start, end] = line.split('-');

                    if(!start || !end) continue;

                    this.updateProgress(`CUTTING ${i+1}/${lines.length}`, Math.round(((i)/lines.length)*100));

                    const worker = this.initWorker();

                    await new Promise((resolve) => {
                        worker.postMessage({
                            type: 'SPLIT_CHUNK',
                            data: {
                                file: this.videoFile,
                                start, end,
                                index: i+1,
                                outputMode: outputMode
                            }
                        });

                        worker.onmessage = (e) => {
                            const { type, buffer, name, msg } = e.data;
                            if (type === 'DONE') {
                                this.downloadFile(buffer, name);
                                resolve();
                            } else if (type === 'ERROR') {
                                this.showToast(`Failed Part ${i+1}: ${msg}`, "error");
                                resolve();
                            }
                        };
                    });

                    worker.terminate();
                    this.worker = null;

                    if (i < lines.length - 1) {
                        this.updateProgress(`COOLDOWN 5s...`, Math.round(((i+1)/lines.length)*100));
                        await new Promise(r => setTimeout(r, 5000));
                    }
                }

                this.showToast("All tasks finished!", "success");
                this.updateProgress("ALL DONE", 100);
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            },

            downloadFile(buffer, name) {
                const mime = name.endsWith('.mp3') ? 'audio/mpeg' : 'video/mp4';
                const blob = new Blob([buffer], { type: mime });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = name;
                a.click();
            },

            updateProgress(text, percent) {
                document.getElementById('progress-text').innerText = text;
                document.getElementById('progress-percent').innerText = percent + "%";
                document.getElementById('progress-bar').style.width = percent + "%";
            }
        };

        window.appCore = AppCore;
        window.onload = () => AppCore.init();

        async function loadFooter() {
            try {
                const response = await fetch('/assets/lander/footer.html');
                if (!response.ok) throw new Error('Footer not found');

                let html = await response.text();
                const realYear = new Date().getFullYear();
                html = html.replace('{YEAR}', realYear);

                document.getElementById('global-footer').innerHTML = html;
                if(window.lucide) window.lucide.createIcons();

            } catch (e) {
                console.warn("Footer load failed:", e);
                const year = new Date().getFullYear();
                document.getElementById('global-footer').innerHTML =
                    `<div class="p-8 text-center text-gray-600 font-mono text-xs">Â© ${year} FLOWORK [OFFLINE]</div>`;
            }
        }
    </script>
</body>
</html>