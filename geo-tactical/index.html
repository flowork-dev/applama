<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geo Tactical | Supply Chain Intelligence</title>
    <script src="../../assets/js/auto-tracker.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/vuetify@3.0.0/dist/vuetify.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@5.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Share+Tech+Mono&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            --bg-core: #050505;
            --neon-cyan: #00f3ff;
            --neon-purple: #bc13fe;
            --input-bg: #121214;
        }

        /* FIX DOUBLE SCROLL: Kunci Body, Scroll di Wrapper */
        html, body {
            margin: 0; padding: 0;
            height: 100%;
            overflow: hidden; /* Mencegah double scrollbar */
            background-color: var(--bg-core);
            font-family: 'Inter', sans-serif;
            color: #e0f0ff;
        }

        /* Container utama buat scroll */
        .app-scroll-frame {
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            scroll-behavior: smooth;
            scrollbar-width: thin;
            scrollbar-color: var(--neon-cyan) var(--bg-core);
        }
        .app-scroll-frame::-webkit-scrollbar { width: 6px; }
        .app-scroll-frame::-webkit-scrollbar-track { background: var(--bg-core); }
        .app-scroll-frame::-webkit-scrollbar-thumb { background: var(--neon-cyan); border-radius: 3px; }

        /* Typography & Custom UI */
        .orbitron { font-family: 'Orbitron', sans-serif; }
        .mono { font-family: 'Share Tech Mono', monospace; }

        .tactical-border {
            border: 1px solid rgba(0, 243, 255, 0.2);
            background: rgba(18, 18, 20, 0.6);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        .tactical-border:hover {
            border-color: var(--neon-cyan);
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.1);
        }

        .nav-btn {
            position: relative;
            opacity: 0.5;
            transition: 0.3s;
            padding-bottom: 10px;
        }
        .nav-btn.active {
            opacity: 1;
            color: var(--neon-cyan);
            text-shadow: 0 0 10px var(--neon-cyan);
            border-bottom: 2px solid var(--neon-cyan);
        }

        .hidden-view { display: none !important; }
    </style>
</head>
<body>
    <v-app style="background: transparent;">
        <div class="app-scroll-frame" id="main-scroll-container">
            <v-main class="p-4 md:p-8 min-h-screen">

                <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-6 max-w-6xl mx-auto">
                    <div class="flex items-center gap-4">
                        <div class="border border-cyan-500/50 p-2 rounded bg-cyan-900/10">
                            <i class="mdi mdi-radar text-cyan-400 text-3xl animate-pulse"></i>
                        </div>
                        <div>
                            <h1 class="orbitron text-3xl font-black text-white tracking-widest leading-none">
                                GEO <span class="text-cyan-400">TACTICAL</span>
                            </h1>
                            <div class="text-[10px] text-purple-400 tracking-[0.4em] font-bold mt-1">SUPPLY CHAIN INTEL V3.5</div>
                        </div>
                    </div>
                    <div id="user-badge" class="hidden px-4 py-1 border border-cyan-500/50 bg-cyan-900/20 text-cyan-400 text-xs mono flex items-center gap-2 rounded-full">
                        <div class="w-2 h-2 bg-cyan-500 rounded-full animate-pulse"></div>
                        UPLINK ESTABLISHED: <span id="user-addr"></span>
                    </div>
                </header>

                <nav class="flex justify-center md:justify-start gap-8 mb-8 border-b border-gray-800 max-w-6xl mx-auto">
                    <button id="tab-scanner" class="nav-btn orbitron text-sm font-bold tracking-widest active cursor-default">
                        SCANNER (APP)
                    </button>
                </nav>

                <div class="max-w-6xl mx-auto">
                    <div id="view-scanner">
                         <div class="bg-[#0f0f13] border border-gray-800 p-6 md:p-8 rounded-2xl mb-8 relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-1 h-full bg-cyan-500"></div>
                            <div class="grid md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-cyan-400 text-xs font-bold mb-2 tracking-widest">TARGET KEYWORD</label>
                                    <input type="text" id="input-query" placeholder="Ex: Coffee Shop, Toko Bangunan" class="w-full bg-[#1a1a20] border border-gray-700 rounded p-4 text-white focus:border-cyan-500 focus:outline-none transition-colors">
                                </div>
                                <div>
                                    <label class="block text-purple-400 text-xs font-bold mb-2 tracking-widest">TARGET LOCATION</label>
                                    <input type="text" id="input-location" placeholder="Ex: Jakarta Selatan" class="w-full bg-[#1a1a20] border border-gray-700 rounded p-4 text-white focus:border-purple-500 focus:outline-none transition-colors">
                                </div>
                            </div>
                            <div class="mt-8 flex justify-end">
                                <button id="btn-scan" onclick="window.appCore.initiateScan()" class="bg-cyan-500 hover:bg-cyan-400 text-black font-bold py-3 px-8 rounded flex items-center gap-2 transition-all shadow-[0_0_20px_rgba(0,243,255,0.3)] hover:shadow-[0_0_30px_rgba(0,243,255,0.5)]">
                                    <i id="btn-icon" class="mdi mdi-radar"></i>
                                    <span id="btn-text">INITIATE SCAN</span>
                                </button>
                            </div>
                            <div id="error-message" class="hidden mt-4 p-3 bg-red-900/30 border border-red-500/50 text-red-200 text-xs mono rounded"></div>
                        </div>

                        <div id="result-stats" class="hidden flex justify-between items-center mb-6 pb-4 border-b border-gray-800">
                            <div><span class="text-gray-400 text-sm">TARGETS FOUND:</span><span id="result-count" class="text-2xl font-bold text-white ml-2">0</span></div>
                            <button id="btn-export" onclick="window.appCore.exportCSV()" class="hidden text-xs text-green-400 border border-green-500/30 px-3 py-1.5 rounded hover:bg-green-900/20 transition-colors flex items-center gap-2"><i class="mdi mdi-microsoft-excel"></i> EXPORT DATA</button>
                        </div>

                        <div id="feed-container" class="space-y-4 pb-20"></div>
                    </div>
                </div>

            </v-main>
        </div>
    </v-app>

    <script>
        // --- FLOWORK SECURITY INTERCEPTOR ---
        async function secureFetch(url, options = {}) {
            try {
                const response = await fetch(url, options);

                // CEK STATUS KRITIKAL
                if (response.status === 401 || response.status === 402 || response.status === 429) {
                    // Lapor ke Main Window (QuickTools.vue)
                    window.parent.postMessage({
                        type: 'FLOWORK_API_ERROR',
                        status: response.status
                    }, '*');

                    // Return null biar app berhenti proses
                    return null;
                }

                return response;
            } catch (e) {
                console.error("Network Error:", e);
                return null;
            }
        }

        const AppCore = {
            userIdentity: null,
            results: [],
            loading: false,

            async init() {
                // Lander loadPartial removed
                console.log("GEO SYSTEM READY.");
            },

            // loadPartial for lander removed

            // switchTab function removed

            copyVar() {
                navigator.clipboard.writeText('GOOGLE_MAPS_KEY');
                alert('Variable Copied: GOOGLE_MAPS_KEY');
            },

            openSettings() {
                window.parent.postMessage({type:'OPEN_SETTINGS', tab:'variables'}, '*');
            },

            async initiateScan() {
                const query = document.getElementById('input-query').value;
                const location = document.getElementById('input-location').value;
                const errMsg = document.getElementById('error-message');
                const btnText = document.getElementById('btn-text');
                const btnIcon = document.getElementById('btn-icon');
                const btn = document.getElementById('btn-scan');
                const feed = document.getElementById('feed-container');
                const stats = document.getElementById('result-stats');
                const count = document.getElementById('result-count');
                const exportBtn = document.getElementById('btn-export');

                if (!query || !location) {
                    errMsg.innerText = "PROTOCOL ERROR: ISI KEYWORD & LOKASI DULU, BRO.";
                    errMsg.classList.remove('hidden');
                    return;
                }

                this.loading = true;
                errMsg.classList.add('hidden');
                btn.disabled = true;
                btnText.innerText = 'SCANNING...';
                btnIcon.classList.remove('mdi-radar');
                btnIcon.classList.add('mdi-loading', 'mdi-spin');
                this.results = [];
                feed.innerHTML = '';

                try {
                    const apiUrl = `/api/v1/geo/scan?q=${encodeURIComponent(query)}&loc=${encodeURIComponent(location)}`;

                    // [FIX] Use secureFetch here!
                    const res = await secureFetch(apiUrl, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-User-Address': this.userIdentity || ''
                        }
                    });

                    // [FIX] Check for null response (Auth/Limit Triggered)
                    if (!res) {
                        this.loading = false;
                        btn.disabled = false;
                        btnText.innerText = 'INITIATE SCAN';
                        btnIcon.classList.remove('mdi-loading', 'mdi-spin');
                        btnIcon.classList.add('mdi-radar');
                        return;
                    }

                    const data = await res.json();

                    if (!res.ok) {
                        errMsg.classList.remove('hidden');
                        errMsg.innerText = `SCAN ERROR: ${data.message || 'System Failure'}`;
                    } else {
                        this.results = data.results;
                        if (this.results.length === 0) {
                            errMsg.innerText = "ZONK. GAK ADA DATA. Coba lokasi lain.";
                            errMsg.classList.remove('hidden');
                        } else {
                            this.results.forEach(place => {
                                const isOpen = place.open;
                                const statusClass = isOpen ? 'text-green-400 border-green-500/30 bg-green-900/10' : 'text-red-400 border-red-500/30 bg-red-900/10';
                                const statusText = isOpen ? 'OPEN' : 'CLOSED';

                                const html = `
                                    <div class="mb-3 p-4 tactical-border rounded-xl">
                                        <div class="flex justify-between items-start">
                                            <div class="flex-grow">
                                                <div class="text-[var(--neon-cyan)] font-bold text-lg hover:text-white transition-colors cursor-pointer">${place.name}</div>
                                                <div class="text-gray-400 text-sm mono mb-2 flex items-center gap-2">
                                                    <i class="mdi mdi-map-marker text-cyan-500"></i> ${place.address}
                                                </div>
                                                <div class="flex flex-wrap gap-2">
                                                    ${place.phone ? `<a href="tel:${place.phone}" class="text-xs text-blue-300 border border-blue-500/30 px-3 py-1 rounded hover:bg-blue-900/50 flex items-center gap-1"><i class="mdi mdi-phone"></i> ${place.phone}</a>` : ''}
                                                    ${place.website ? `<a href="${place.website}" target="_blank" class="text-xs text-purple-300 border border-purple-500/30 px-3 py-1 rounded hover:bg-purple-900/50 flex items-center gap-1"><i class="mdi mdi-web"></i> WEB</a>` : ''}
                                                </div>
                                            </div>
                                            <div class="text-right flex-none ml-4">
                                                <div class="${statusClass} text-[10px] font-bold px-3 py-1 border rounded text-center mb-1">
                                                    ${place.open !== undefined ? statusText : '???'}
                                                </div>
                                                <div class="flex items-center justify-end text-yellow-400 text-sm font-bold bg-yellow-900/10 px-2 py-0.5 rounded border border-yellow-500/20">
                                                    ${place.rating || '0'} <i class="mdi mdi-star text-xs ml-1"></i>
                                                    <span class="text-gray-600 text-[10px] ml-1">(${place.user_ratings_total || 0})</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                feed.insertAdjacentHTML('beforeend', html);
                            });
                            stats.classList.remove('hidden');
                            count.innerText = this.results.length;
                            exportBtn.classList.remove('hidden');
                        }
                    }
                } catch (e) {
                    console.error(e);
                    errMsg.innerText = "SYSTEM FAILURE: CONNECTION LOST.";
                    errMsg.classList.remove('hidden');
                } finally {
                    this.loading = false;
                    btn.disabled = false;
                    btnText.innerText = 'INITIATE SCAN';
                    btnIcon.classList.remove('mdi-loading', 'mdi-spin');
                    btnIcon.classList.add('mdi-radar');
                }
            },

            exportCSV() {
                if (this.results.length === 0) return;
                const headers = ["Name", "Address", "Phone", "Website", "Rating", "Review Count", "Status", "Price Level"];
                const rows = this.results.map(p => [
                    `"${p.name}"`, `"${p.address}"`, `"${p.phone || ''}"`, `"${p.website || ''}"`,
                    p.rating, p.user_ratings_total, p.open ? 'OPEN' : 'CLOSED', p.price || ''
                ]);
                const csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.map(e => e.join(",")).join("\n");
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", `geo_intel_${Date.now()}.csv`);
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            }
        };

        window.appCore = AppCore;
        window.onload = () => AppCore.init();

        window.addEventListener('message', (event) => {
            if (event.data?.type === 'FLOWORK_IDENTITY_SYNC') {
                AppCore.userIdentity = event.data.userAddress;
                document.getElementById('user-badge').classList.remove('hidden');
                document.getElementById('user-addr').innerText = event.data.userAddress.substring(0,8) + '...';

                const apiPanel = document.getElementById('api-config-panel');
                if(apiPanel) apiPanel.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>