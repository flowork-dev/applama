<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes" />
    <title>Sonic Vault | Secure Audio Steganography</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <style>
        :root { --bg-core: #0b0c15; --neon-green: #0aff60; --neon-red: #ff2a6d; }

        body {
            background-color: var(--bg-core);
            color: #a0a0a0;
            font-family: 'Rajdhani', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .tech-font { font-family: 'Share Tech Mono', monospace; }

        ::-webkit-scrollbar { width: 6px; background: #050505; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--neon-green); }

        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }
        .scanline::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, transparent, rgba(10, 255, 96, 0.1), transparent);
            animation: scanline 4s linear infinite;
            pointer-events: none;
        }

        /* --- FIX POPUP TENGAH LAYAR --- */
        #toast-container {
            position: fixed;
            top: 50%;  /* Pas di tengah vertikal */
            left: 50%; /* Pas di tengah horizontal */
            transform: translate(-50%, -50%) scale(0.9); /* Start agak kecil */
            z-index: 100000; /* LEBIH TINGGI DARI HEADER APAPUN */
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0;
            width: 90%;
            max-width: 350px;
            pointer-events: none;
            box-shadow: 0 0 50px rgba(0,0,0,0.8); /* Shadow tebal biar standout */
        }
        #toast-container.active {
            transform: translate(-50%, -50%) scale(1); /* Scale normal */
            opacity: 1;
            pointer-events: auto;
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <nav class="h-16 border-b border-gray-800 bg-[#050505] flex items-center justify-between px-6 z-50 shrink-0 shadow-lg">
        <div class="flex items-center gap-3">
            <i data-lucide="waves" class="text-green-500 w-6 h-6"></i>
            <div class="text-xl font-bold text-white tracking-wider tech-font">SONIC<span class="text-green-500">VAULT</span></div>
        </div>
        <div class="flex items-center gap-2">
            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
            <span class="text-xs font-mono text-green-500">SYSTEM V.2.0</span>
        </div>
    </nav>

    <main class="flex-1 flex flex-col md:flex-row w-full h-full overflow-hidden relative">

        <div class="w-full md:w-1/3 bg-[#0b0c15] border-t md:border-t-0 md:border-r border-gray-800 flex flex-col relative z-20 shadow-2xl order-2 md:order-1 h-3/5 md:h-full">

            <div class="flex border-b border-gray-800 shrink-0 sticky top-0 bg-[#0b0c15] z-10 shadow-md">
                <button onclick="window.appCore.setMode('encode')" id="btn-encode" class="flex-1 py-4 text-sm font-bold tech-font flex items-center justify-center gap-2 transition-all bg-[#0aff6010] text-green-400 border-b-2 border-green-500">
                    <i data-lucide="lock" class="w-4 h-4"></i> WRITE (ENCRYPT)
                </button>
                <button onclick="window.appCore.setMode('decode')" id="btn-decode" class="flex-1 py-4 text-sm font-bold tech-font flex items-center justify-center gap-2 transition-all opacity-50 bg-black text-gray-500 hover:text-white border-transparent">
                    <i data-lucide="unlock" class="w-4 h-4"></i> READ (DECRYPT)
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-6 flex flex-col relative">

                <div id="ui-encode" class="flex flex-col gap-6">
                    <div class="p-4 rounded border border-gray-800 bg-black/40 hover:border-green-500/50 transition-colors group">
                        <label class="text-[10px] text-gray-500 uppercase tracking-widest font-bold mb-2 block group-hover:text-green-500">1. SOURCE AUDIO (WAV ONLY)</label>
                        <input type="file" id="audioInput" accept="audio/wav" class="hidden" onchange="window.appCore.handleAudio(this)">
                        <button onclick="document.getElementById('audioInput').click()" class="w-full py-4 border border-dashed border-gray-700 hover:border-green-500 text-gray-400 hover:text-green-400 rounded text-xs font-mono transition-all flex flex-col items-center gap-2">
                            <i data-lucide="upload-cloud" class="w-5 h-5 mb-1"></i>
                            <span id="label-audio-input">SELECT .WAV FILE</span>
                        </button>
                    </div>

                    <div class="group">
                        <label class="text-[10px] text-gray-500 uppercase tracking-widest font-bold mb-2 block group-hover:text-green-500">2. SECRET MESSAGE</label>
                        <textarea id="secretMessage" class="w-full bg-black border border-gray-800 rounded p-3 text-green-400 font-mono text-xs focus:border-green-500 focus:outline-none min-h-[100px] placeholder-gray-700" placeholder="Type your hidden message here..."></textarea>
                    </div>

                    <div class="group">
                        <label class="text-[10px] text-gray-500 uppercase tracking-widest font-bold mb-2 block group-hover:text-green-500">3. PASSWORD (REQUIRED)</label>
                        <div class="relative">
                            <input type="password" id="secretKey" class="w-full bg-black border border-gray-800 rounded p-3 pl-10 text-white font-mono text-xs focus:border-green-500 focus:outline-none" placeholder="Set a secure password...">
                            <i data-lucide="key" class="absolute left-3 top-3 w-4 h-4 text-gray-600"></i>
                        </div>
                    </div>
                </div>

                <div id="ui-decode" class="hidden flex flex-col gap-6">
                    <div class="p-4 rounded border border-gray-800 bg-black/40 hover:border-red-500/50 transition-colors group">
                        <label class="text-[10px] text-gray-500 uppercase tracking-widest font-bold mb-2 block group-hover:text-red-500">SOURCE FILE</label>
                        <input type="file" id="decodeInput" accept="audio/wav" class="hidden" onchange="window.appCore.handleDecodeInput(this)">
                        <button onclick="document.getElementById('decodeInput').click()" class="w-full py-6 border border-dashed border-gray-700 hover:border-red-500 text-gray-400 hover:text-red-400 rounded text-xs font-mono transition-all flex flex-col items-center gap-2">
                            <i data-lucide="file-audio" class="w-5 h-5 mb-1"></i>
                            <span id="label-decode-input">SELECT ENCRYPTED .WAV</span>
                        </button>
                    </div>
                    <div class="group">
                        <label class="text-[10px] text-gray-500 uppercase tracking-widest font-bold mb-2 block group-hover:text-red-500">DECRYPTION KEY</label>
                        <div class="relative">
                            <input type="password" id="decodeKey" class="w-full bg-black border border-gray-800 rounded p-3 pl-10 text-white font-mono text-xs focus:border-red-500 focus:outline-none" placeholder="Enter password to unlock...">
                            <i data-lucide="unlock" class="absolute left-3 top-3 w-4 h-4 text-gray-600"></i>
                        </div>
                    </div>

                    <div id="result-box" class="hidden bg-red-900/10 border border-red-500/30 p-4 rounded min-h-[100px] relative mt-4">
                        <div class="text-[10px] text-red-500 font-bold mb-2 tracking-widest">DECODED MESSAGE:</div>
                        <p id="decoded-result" class="text-white font-mono text-sm break-words whitespace-pre-wrap">...</p>
                        <button onclick="window.appCore.copyText()" class="absolute bottom-2 right-2 text-red-400 hover:text-white text-[10px] uppercase font-bold border border-red-500/30 px-2 py-1 rounded bg-black/50">COPY</button>
                    </div>
                </div>

                <div class="mt-8 shrink-0">
                    <button id="btn-process" onclick="window.appCore.process()" class="w-full py-4 bg-green-600 hover:bg-green-500 text-black font-bold font-mono tracking-widest text-lg rounded shadow-[0_0_20px_rgba(34,197,94,0.4)] transition-all flex items-center justify-center gap-2">
                        <i data-lucide="cpu"></i> INJECT AUDIO
                    </button>
                </div>

                <div id="global-footer" class="mt-6 border-t border-gray-800 pt-6 pb-4"></div>
                <div class="h-10"></div>
            </div>
        </div>

        <div class="w-full md:w-2/3 bg-black relative flex items-center justify-center overflow-hidden order-1 md:order-2 h-2/5 md:h-full shrink-0 scanline">
            <div class="absolute inset-0 opacity-20" style="background-image: linear-gradient(#0aff60 1px, transparent 1px), linear-gradient(90deg, #0aff60 1px, transparent 1px); background-size: 40px 40px; perspective: 1000px; transform: rotateX(60deg) scale(2);"></div>
            <div class="relative z-10 w-[180px] md:w-[400px] h-[180px] md:h-[400px] border border-green-500/20 rounded-full flex items-center justify-center transition-all duration-500" id="visualizer-container">
                <div class="absolute inset-0 rounded-full border border-green-500/10 animate-[spin_10s_linear_infinite]"></div>
                <div class="w-[140px] md:w-[300px] h-[140px] md:h-[300px] border border-dashed border-green-500/30 rounded-full animate-[spin_20s_linear_infinite_reverse]"></div>
                <canvas id="visualizer" class="absolute inset-0 w-full h-full opacity-80" style="filter: drop-shadow(0 0 10px #0aff60);"></canvas>
                <div class="absolute bg-black/50 backdrop-blur border border-green-500/50 p-4 rounded-full shadow-[0_0_30px_#0aff60]">
                    <i data-lucide="activity" class="w-6 h-6 md:w-8 md:h-8 text-green-400"></i>
                </div>
            </div>
            <div class="absolute top-4 right-4 text-right z-20">
                <div class="text-[9px] text-gray-500 font-mono">SYSTEM STATUS</div>
                <div id="status-text" class="text-xl font-bold font-mono text-green-500 animate-pulse">IDLE</div>
            </div>
        </div>
    </main>

    <div id="toast-container" class="bg-gray-900 border border-l-4 border-green-500 px-6 py-4 rounded shadow-2xl flex items-center gap-4">
        <div id="toast-icon" class="text-green-500"><i data-lucide="check-circle"></i></div>
        <div>
            <h4 id="toast-title" class="text-white font-bold text-sm tech-font">SUCCESS</h4>
            <p id="toast-message" class="text-gray-400 text-xs font-mono">Operation completed successfully.</p>
        </div>
    </div>

    <script>
        function showToast(title, message, type = 'success') {
            const container = document.getElementById('toast-container');
            const titleEl = document.getElementById('toast-title');
            const msgEl = document.getElementById('toast-message');
            const iconEl = document.getElementById('toast-icon');

            titleEl.innerText = title;
            msgEl.innerText = message;

            container.className = "bg-gray-900 border border-l-4 px-6 py-4 rounded shadow-2xl flex items-center gap-4";

            if (type === 'error') {
                container.classList.add('border-red-500');
                titleEl.className = "text-red-500 font-bold text-sm tech-font";
                iconEl.innerHTML = '<i data-lucide="alert-triangle" class="text-red-500"></i>';
            } else {
                container.classList.add('border-green-500');
                titleEl.className = "text-green-500 font-bold text-sm tech-font";
                iconEl.innerHTML = '<i data-lucide="check-circle" class="text-green-500"></i>';
            }
            lucide.createIcons();
            container.classList.add('active');
            setTimeout(() => { container.classList.remove('active'); }, 3000);
        }

        const AppCore = {
            mode: 'encode',
            rawBuffer: null,
            audioBuffer: null,
            audioContext: null,
            protocolHeader: "SONIC::",
            protocolFooter: "::EOF",

            init() {
                lucide.createIcons();
                loadFooter();
                this.setMode('encode');
            },

            setMode(m) {
                this.mode = m;
                const btnEnc = document.getElementById('btn-encode');
                const btnDec = document.getElementById('btn-decode');
                const uiEnc = document.getElementById('ui-encode');
                const uiDec = document.getElementById('ui-decode');
                const btnProcess = document.getElementById('btn-process');
                const status = document.getElementById('status-text');
                const visContainer = document.getElementById('visualizer-container');

                btnEnc.className = "flex-1 py-4 text-sm font-bold tech-font flex items-center justify-center gap-2 transition-all opacity-50 bg-black text-gray-500 border-b-2 border-transparent";
                btnDec.className = "flex-1 py-4 text-sm font-bold tech-font flex items-center justify-center gap-2 transition-all opacity-50 bg-black text-gray-500 border-b-2 border-transparent";

                if(m === 'encode') {
                    btnEnc.className = "flex-1 py-4 text-sm font-bold tech-font flex items-center justify-center gap-2 transition-all bg-[#0aff6010] text-green-400 border-b-2 border-green-500";
                    uiEnc.classList.remove('hidden');
                    uiDec.classList.add('hidden');
                    btnProcess.innerHTML = '<i data-lucide="cpu"></i> INJECT AUDIO';
                    btnProcess.className = "w-full py-4 bg-green-600 hover:bg-green-500 text-black font-bold font-mono tracking-widest text-lg rounded shadow-[0_0_20px_rgba(34,197,94,0.4)] transition-all flex items-center justify-center gap-2";
                    status.innerText = "MODE: WRITE";
                    status.className = "text-xl font-bold font-mono text-green-500 animate-pulse";
                    visContainer.style.borderColor = "rgba(10, 255, 96, 0.2)";
                } else {
                    btnDec.className = "flex-1 py-4 text-sm font-bold tech-font flex items-center justify-center gap-2 transition-all bg-[#ff2a6d10] text-red-400 border-b-2 border-red-500";
                    uiDec.classList.remove('hidden');
                    uiEnc.classList.add('hidden');
                    btnProcess.innerHTML = '<i data-lucide="search"></i> EXTRACT DATA';
                    btnProcess.className = "w-full py-4 bg-red-600 hover:bg-red-500 text-black font-bold font-mono tracking-widest text-lg rounded shadow-[0_0_20px_rgba(255,42,109,0.4)] transition-all flex items-center justify-center gap-2";
                    status.innerText = "MODE: READ";
                    status.className = "text-xl font-bold font-mono text-red-500 animate-pulse";
                    visContainer.style.borderColor = "rgba(255, 42, 109, 0.2)";
                }
                lucide.createIcons();
                this.visualize();
            },

            handleAudio(input) {
                if(input.files && input.files[0]) {
                    const file = input.files[0];
                    if(file.type !== "audio/wav" && !file.name.endsWith('.wav')) {
                         showToast("INVALID FILE", "Please use .WAV files only!", "error");
                         return;
                    }
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        this.rawBuffer = e.target.result.slice(0);
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        this.audioBuffer = await this.audioContext.decodeAudioData(e.target.result);
                        this.visualize();
                        const lbl = document.getElementById(this.mode === 'encode' ? 'label-audio-input' : 'label-decode-input');
                        if(lbl) lbl.innerText = file.name;
                        showToast("AUDIO LOADED", `Size: ${(this.rawBuffer.byteLength / 1024 / 1024).toFixed(2)} MB`, 'success');
                    };
                    reader.readAsArrayBuffer(file);
                }
            },

            handleDecodeInput(input) { this.handleAudio(input); },

            visualize() {
                const canvas = document.getElementById("visualizer");
                if(!canvas || canvas.offsetParent === null) return;
                canvas.width = canvas.parentElement.offsetWidth;
                canvas.height = canvas.parentElement.offsetHeight;
                const canvasCtx = canvas.getContext("2d");
                canvasCtx.clearRect(0, 0, canvas.width, canvas.height);

                if (!this.audioBuffer) {
                    canvasCtx.strokeStyle = '#333'; canvasCtx.beginPath(); canvasCtx.moveTo(0, canvas.height/2); canvasCtx.lineTo(canvas.width, canvas.height/2); canvasCtx.stroke(); return;
                }

                const rawData = this.audioBuffer.getChannelData(0);
                const step = Math.ceil(rawData.length / canvas.width);
                const amp = canvas.height / 2;
                canvasCtx.lineWidth = 2;
                canvasCtx.strokeStyle = this.mode === 'encode' ? '#0aff60' : '#ff2a6d';
                canvasCtx.beginPath();
                for (let i = 0; i < canvas.width; i++) {
                    let min = 1.0; let max = -1.0;
                    for (let j = 0; j < step; j++) {
                        const datum = rawData[(i * step) + j];
                        if (datum < min) min = datum; if (datum > max) max = datum;
                    }
                    canvasCtx.moveTo(i, (1 + min) * amp); canvasCtx.lineTo(i, (1 + max) * amp);
                }
                canvasCtx.stroke();
            },

            strToBin(str) {
                let bin = "";
                for (let i = 0; i < str.length; i++) {
                    bin += str.charCodeAt(i).toString(2).padStart(8, '0');
                }
                return bin;
            },

            binToStr(bin) {
                let str = "";
                for (let i = 0; i < bin.length; i += 8) {
                    str += String.fromCharCode(parseInt(bin.substr(i, 8), 2));
                }
                return str;
            },

            xorCipher(text, key) {
                if (!key) return text;
                let res = "";
                for (let i = 0; i < text.length; i++) {
                    res += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
                }
                return res;
            },

            findDataOffset(view) {
                let offset = 12;
                while (offset < view.byteLength) {
                    const chunkId = String.fromCharCode(view.getUint8(offset), view.getUint8(offset+1), view.getUint8(offset+2), view.getUint8(offset+3));
                    offset += 4;
                    const chunkSize = view.getUint32(offset, true);
                    offset += 4;
                    if (chunkId === 'data') return offset;
                    offset += chunkSize;
                }
                return 44;
            },

            async process() {
                const btn = document.getElementById('btn-process');
                if (!this.rawBuffer) return showToast("ERROR", "Please upload a WAV file first.", "error");

                const originalText = btn.innerHTML;
                btn.innerText = "PROCESSING...";
                btn.disabled = true;

                try {
                    if (this.mode === 'encode') {
                        const msg = document.getElementById('secretMessage').value;
                        const pwd = document.getElementById('secretKey').value;

                        if(!msg) throw new Error("Secret message is empty!");
                        if(!pwd) throw new Error("Password is required!");

                        const encryptedMsg = this.xorCipher(msg, pwd);
                        const fullPayload = this.protocolHeader + encryptedMsg + this.protocolFooter;
                        const bits = this.strToBin(fullPayload);

                        const newBuffer = this.rawBuffer.slice(0);
                        const view = new DataView(newBuffer);
                        const bytes = new Uint8Array(newBuffer);
                        const dataOffset = this.findDataOffset(view);

                        if(bits.length > (bytes.length - dataOffset)) throw new Error("Message too long for this audio file.");

                        for(let i = 0; i < bits.length; i++) {
                            const bit = parseInt(bits[i]);
                            const byteIndex = dataOffset + i;
                            bytes[byteIndex] = (bytes[byteIndex] & 0xFE) | bit;
                        }

                        const wavBlob = new Blob([bytes], { type: 'audio/wav' });
                        const url = URL.createObjectURL(wavBlob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `sonic_secure_${Date.now()}.wav`;
                        a.click();
                        showToast("SUCCESS", "Data injected successfully!", "success");
                    }
                    else {
                        const pwd = document.getElementById('decodeKey').value;
                        if(!pwd) throw new Error("Please enter password to decrypt.");

                        const view = new DataView(this.rawBuffer);
                        const bytes = new Uint8Array(this.rawBuffer);
                        const dataOffset = this.findDataOffset(view);

                        let extractedBits = "";
                        const limit = Math.min(bytes.length, dataOffset + 500000);
                        for(let i = dataOffset; i < limit; i++) {
                            extractedBits += (bytes[i] & 1).toString();
                        }

                        const fullText = this.binToStr(extractedBits);

                        const headerIndex = fullText.indexOf(this.protocolHeader);
                        if (headerIndex !== 0) {
                             throw new Error("No hidden data found or wrong format.");
                        }

                        const footerIndex = fullText.indexOf(this.protocolFooter);
                        if (footerIndex === -1) throw new Error("Data corrupted or incomplete.");

                        const rawPayload = fullText.substring(this.protocolHeader.length, footerIndex);
                        const decrypted = this.xorCipher(rawPayload, pwd);

                        document.getElementById('result-box').classList.remove('hidden');
                        const resultEl = document.getElementById('decoded-result');

                        resultEl.innerText = decrypted;
                        showToast("DONE", "Data extracted.", "success");
                    }

                } catch(e) {
                    showToast("FAILED", e.message, "error");
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            },

            copyText() {
                const t = document.getElementById('decoded-result').innerText;
                navigator.clipboard.writeText(t);
                showToast("COPIED", "Text copied to clipboard", "success");
            }
        };

        window.appCore = AppCore;
        window.onload = () => AppCore.init();

        async function loadFooter() {
            try {
                const response = await fetch('/assets/lander/footer.html');
                if (!response.ok) throw new Error('Footer not found');
                let html = await response.text();
                html = html.replace('{YEAR}', new Date().getFullYear());
                document.getElementById('global-footer').innerHTML = html;
                if(window.lucide) window.lucide.createIcons();
            } catch (e) {
                console.warn("Footer error:", e);
                document.getElementById('global-footer').innerHTML = `<div class="p-8 text-center text-gray-600 font-mono text-xs border-t border-gray-800">Â© ${new Date().getFullYear()} FLOWORK [OFFLINE]</div>`;
            }
        }
    </script>
</body>
</html>