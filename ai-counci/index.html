<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI COUNCIL WAR ROOM</title>
    <script src="../../assets/js/auto-tracker.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root { --bg-core: #171925; --neon-cyan: #54d7f6; --text-main: #e0f0ff; }
        body { background-color: var(--bg-core); color: var(--text-main); font-family: 'Outfit', sans-serif; overflow: hidden; }
        .hidden-view { display: none !important; }
        .hidden-section { display: none; }
        main { overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .tab-btn { opacity: 0.6; border-bottom: 2px solid transparent; transition: 0.3s; }
        .tab-btn.active { opacity: 1; color: var(--neon-cyan); border-bottom: 2px solid var(--neon-cyan); }
    </style>
</head>
<body class="flex flex-col h-screen">

    <nav class="h-16 border-b border-[#3a3962] bg-[#171925]/95 flex items-center justify-between px-6 z-50 shrink-0">
        <div class="flex items-center gap-3">
            <img src="icon.svg" class="w-8 h-8">
            <div>
                <span class="font-bold tracking-tight text-sm block leading-none">AI COUNCIL</span>
                <span class="text-[9px] text-gray-500 font-mono tracking-widest">WAR ROOM V3.4</span>
            </div>
        </div>
        <div class="flex gap-6 text-xs font-bold tracking-widest h-full">
            <button onclick="AppCore.switchTab('app')" id="tab-app" class="tab-btn active h-full flex items-center gap-2">
                INTELLIGENCE <i data-lucide="lock" id="lock-icon" class="w-3 h-3 text-gray-500"></i>
            </button>
        </div>
    </nav>

    <main class="flex-1 relative w-full h-full">
        <div id="view-app" class="w-full min-h-full h-full"></div>
    </main>

    <script>
        async function secureFetch(url, options = {}) {
            // 1. CEK LOGIN (GATEKEEPER)
            if (!AppCore.isLoggedIn) {
                window.parent.postMessage({ type: 'FLOWORK_API_ERROR', status: 401 }, '*');
                return null;
            }
            try {
                if (!options.headers) options.headers = {};
                options.headers['X-User-Address'] = AppCore.currentUserAddress;
                const response = await fetch(url, options);
                // 2. CEK CONFIG/LIMIT
                if (response.status === 402 || response.status === 429) {
                    window.parent.postMessage({ type: 'FLOWORK_API_ERROR', status: response.status }, '*');
                    return null;
                }
                return response;
            } catch (e) {
                console.error("Network Error:", e);
                return null;
            }
        }

        const AppCore = {
            currentUserAddress: null,
            isLoggedIn: false,
            async init() {
                // Lander loadPartial removed
                await this.loadPartial('view-app', 'partials/app.html');
                if(typeof lucide !== 'undefined') lucide.createIcons();
            },
            async loadPartial(id, url) {
                try {
                    const res = await fetch(url);
                    const html = await res.text();
                    const container = document.getElementById(id);
                    container.innerHTML = html;
                    const scripts = container.querySelectorAll("script");
                    scripts.forEach(old => {
                        const script = document.createElement("script");
                        Array.from(old.attributes).forEach(attr => script.setAttribute(attr.name, attr.value));
                        script.appendChild(document.createTextNode(old.innerHTML));
                        old.parentNode.replaceChild(script, old);
                    });
                } catch(e) { console.error(e); }
            },
            switchTab(tab) {
                // Removed references to view-lander and tab-lander to prevent JS errors
                document.getElementById('view-app').classList.add('hidden-view');
                document.getElementById('tab-app').classList.remove('active');

                document.getElementById(`view-${tab}`).classList.remove('hidden-view');
                document.getElementById(`tab-${tab}`).classList.add('active');
                if(typeof lucide !== 'undefined') lucide.createIcons();
            },
            openSettings() {
                window.parent.postMessage({type:'OPEN_SETTINGS', tab:'variables'}, '*');
            }
        };

        window.AppCore = AppCore;
        window.onload = () => AppCore.init();

        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'FLOWORK_IDENTITY_SYNC') {
                AppCore.currentUserAddress = event.data.userAddress;
                AppCore.isLoggedIn = !!AppCore.currentUserAddress;
                if (AppCore.isLoggedIn) {
                    const lockIcon = document.getElementById('lock-icon');
                    if(lockIcon) {
                        lockIcon.setAttribute('data-lucide', 'unlock');
                        lockIcon.classList.remove('text-gray-500');
                        lockIcon.classList.add('text-green-400');
                        if(typeof lucide !== 'undefined') lucide.createIcons();
                    }
                    const tutorial = document.getElementById('api-tutorial');
                    if(tutorial) tutorial.classList.remove('hidden-section');
                    AppCore.switchTab('app');
                }
            }
        });
    </script>
</body>
</html>